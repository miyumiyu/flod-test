<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Foldy Bird Clone</title>
    <style>
        body { margin: 0; padding: 0; overflow: hidden; background: #70c5ce; }
        canvas { display: block; margin: 0 auto; background: #70c5ce; }
        #status {
            position: absolute; top: 10px; left: 10px; 
            font-family: monospace; font-size: 16px; color: white; 
            background: rgba(0,0,0,0.5); padding: 5px;
        }
    </style>
</head>
<body>
    <div id="status">PC: クリック / Mobile: 折りたたみ動作でジャンプ</div>
    <canvas id="gameCanvas"></canvas>

<script>
    // --- ゲームの基本設定 ---
    const canvas = document.getElementById('gameCanvas');
    const ctx = canvas.getContext('2d');
    
    // 画面サイズ調整
    canvas.width = window.innerWidth;
    canvas.height = window.innerHeight;

    let bird = { x: 50, y: 150, width: 20, height: 20, velocity: 0, gravity: 0.6, jump: -10 };
    let pipes = [];
    let frame = 0;
    let score = 0;
    let isGameOver = false;

    // --- メインループ ---
    function gameLoop() {
        if (isGameOver) return;

        ctx.clearRect(0, 0, canvas.width, canvas.height);

        // 鳥の物理演算
        bird.velocity += bird.gravity;
        bird.y += bird.velocity;

        // 鳥の描画
        ctx.fillStyle = "yellow";
        ctx.fillRect(bird.x, bird.y, bird.width, bird.height);

        // 土管の生成と移動
        if (frame % 100 === 0) {
            let pipeHeight = Math.random() * (canvas.height - 200) + 50;
            pipes.push({ x: canvas.width, y: 0, width: 50, height: pipeHeight, passed: false }); // 上の土管
            pipes.push({ x: canvas.width, y: pipeHeight + 150, width: 50, height: canvas.height, passed: false }); // 下の土管
        }

        for (let i = 0; i < pipes.length; i++) {
            let p = pipes[i];
            p.x -= 3; // スクロール速度

            // 土管の描画
            ctx.fillStyle = "green";
            ctx.fillRect(p.x, p.y, p.width, p.height);

            // 衝突判定
            if (
                bird.x < p.x + p.width &&
                bird.x + bird.width > p.x &&
                bird.y < p.y + p.height &&
                bird.y + bird.height > p.y
            ) {
                gameOver();
            }
        }

        // 床・天井判定
        if (bird.y > canvas.height || bird.y < 0) {
            gameOver();
        }

        // 不要な土管の削除
        if (pipes.length > 0 && pipes[0].x < -50) {
            pipes.shift();
            pipes.shift(); // 上下セットで削除
        }

        frame++;
        requestAnimationFrame(gameLoop);
    }

    function doJump() {
        if (isGameOver) {
            // リセット
            bird.y = 150;
            bird.velocity = 0;
            pipes = [];
            frame = 0;
            isGameOver = false;
            gameLoop();
        } else {
            bird.velocity = bird.jump;
        }
    }

    function gameOver() {
        isGameOver = true;
        ctx.fillStyle = "white";
        ctx.font = "30px Arial";
        ctx.fillText("Game Over", canvas.width / 2 - 80, canvas.height / 2);
        ctx.fillText("Fold/Click to Retry", canvas.width / 2 - 120, canvas.height / 2 + 40);
    }

    // --- 入力イベントの設定 ---

    // 1. マウス/タッチ (デバッグ用)
    window.addEventListener('mousedown', doJump);
    window.addEventListener('touchstart', (e) => { e.preventDefault(); doJump(); }, {passive: false});

    // 2. 折りたたみスマホ (Device Posture API)
    // 注意: まだ実験的なAPIであり、Chromeのフラグ設定等が必要な場合があります。
    if (navigator.devicePosture) {
        document.getElementById('status').innerText = "Device Posture API Supported!";
        
        navigator.devicePosture.addEventListener('change', (event) => {
            // 姿勢が変わったとき（例: 開いた状態 <-> 折った状態）にジャンプ
            // 'folded' 状態になったとき、あるいは状態変化そのものをトリガーにする
            const type = navigator.devicePosture.type;
            document.getElementById('status').innerText = `Posture: ${type}`;
            
            // 例: 「連続(フラット)」から「折れ曲がり」に変わったらジャンプ
            // 実際には感度調整のため、changeイベントが発火するたびにジャンプさせる実装が多いかもしれません
            doJump(); 
        });
    } else {
        // Fallback: Device Orientation APIを使用する場合の簡易ロジック
        // ヒンジの角度を直接取得するのは難しいため、急激な角度変化(beta/gamma)を検知する
        let lastBeta = 0;
        window.addEventListener("deviceorientation", (event) => {
            const currentBeta = event.beta; // 前後の傾き
            if (Math.abs(currentBeta - lastBeta) > 20) { // 閾値（感度）
                // 急激に傾きが変わったらジャンプとみなす
                 // doJump(); // 誤作動が多いためコメントアウトしています。必要に応じて有効化してください
            }
            lastBeta = currentBeta;
        });
    }

    // ゲーム開始
    gameLoop();

</script>
</body>
</html>
