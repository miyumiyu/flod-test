<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="mobile-web-app-capable" content="yes">
    <title>Foldable Image Switcher (Ultimate)</title>
    <style>
        body, html {
            margin: 0;
            padding: 0;
            width: 100%;
            height: 100%;
            overflow: hidden;
            background-color: #000;
            /* 長押しメニューなどを無効化 */
            -webkit-touch-callout: none;
            -webkit-user-select: none;
            user-select: none;
        }

        #displayImage {
            width: 100%;
            height: 100%;
            object-fit: contain; 
            display: block;
            pointer-events: auto; /* タップを受け付ける */
        }

        /* 設定メニューのスタイル */
        #settings-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.9);
            display: none; /* 初期は非表示 */
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 100;
            color: white;
            font-family: sans-serif;
        }

        .upload-btn {
            background: #444;
            color: #fff;
            border: 1px solid #666;
            padding: 15px;
            margin: 10px;
            font-size: 16px;
            border-radius: 8px;
            cursor: pointer;
            width: 80%;
            text-align: center;
        }

        .close-btn {
            margin-top: 30px;
            background: #d9534f;
            border: none;
        }

        h2 { margin-bottom: 20px; font-size: 18px; }
        p { font-size: 12px; color: #aaa; margin-top: -5px; margin-bottom: 15px; }
    </style>
</head>
<body>
    
    <img id="displayImage" src="1.png" alt="長押しで設定">

    <div id="settings-overlay">
        <h2>画像設定メニュー</h2>
        
        <button class="upload-btn" onclick="document.getElementById('file-normal').click()">
            ① [通常] 画像を選択
        </button>
        <p>現在: <span id="status-normal">1.png (初期)</span></p>

        <button class="upload-btn" onclick="document.getElementById('file-folded').click()">
            ② [折畳] 画像を選択
        </button>
        <p>現在: <span id="status-folded">2.png (初期)</span></p>

        <button class="upload-btn close-btn" onclick="closeSettings()">
            閉じる
        </button>
    </div>

    <input type="file" id="file-normal" accept="image/*" style="display: none;">
    <input type="file" id="file-folded" accept="image/*" style="display: none;">

    <script>
        // --- 設定変数 ---
        // 初期値はファイル名ですが、アップロード後はDataURLになります
        let image1Src = '1.png';
        let image2Src = '2.png';
        
        const imgElement = document.getElementById('displayImage');
        const overlay = document.getElementById('settings-overlay');
        let currentImageStr = "";

        // --- 画像切り替え関数 ---
        function switchImage(targetImageSrc) {
            // 同じ画像なら更新しない（チラつき防止）
            if (currentImageStr !== targetImageSrc) {
                imgElement.src = targetImageSrc;
                currentImageStr = targetImageSrc;
            }
        }

        // 初期表示
        switchImage(image1Src);

        // --- 全画面化＆回転ロック処理 (頂いたコードを採用) ---
        async function enableFullScreenAndLock() {
            try {
                if (!document.fullscreenElement) {
                    await document.documentElement.requestFullscreen();
                }
                // 回転ロック (Portrait)
                if (screen.orientation && screen.orientation.lock) {
                    await screen.orientation.lock("portrait");
                }
            } catch (err) {
                console.log("Lock failed:", err);
            }
        }

        // --- イベントリスナー ---

        // タップ時の処理（画像1に戻す ＆ 全画面・ロック発動）
        function handleTap(e) {
            // 設定メニューが開いている、または設定メニュー内のタップなら無視
            if (overlay.style.display === 'flex' || e.target.closest('#settings-overlay')) {
                return; 
            }

            // タッチのデフォルト動作を無効化（ズーム等防止）
            if (e.type === 'touchstart') e.preventDefault();
            
            // 画像を戻す (image1Src変数を参照するように変更)
            switchImage(image1Src);
            
            // 全画面＆ロックを実行
            enableFullScreenAndLock();
        }

        // 画像要素に対してのみタップ判定を行う
        imgElement.addEventListener('click', handleTap);
        imgElement.addEventListener('touchstart', handleTap, {passive: false});


        // --- 折りたたみ検知 (頂いた成功コードを採用) ---
        
        // 方法A: Device Posture API
        if (navigator.devicePosture) {
            navigator.devicePosture.addEventListener('change', (event) => {
                // 折れたら image2Src を表示
                // ※姿勢の判定を追加しても良いですが、changeイベント発火＝変化とみなして切り替えます
                // 必要であれば event.type === 'folded' などの判定を入れてください
                switchImage(image2Src);
            });
        } 
        // 方法B: リサイズ検知 (フォールバック)
        else {
            let lastAspectRatio = window.innerWidth / window.innerHeight;
            window.addEventListener('resize', () => {
                const currentAspectRatio = window.innerWidth / window.innerHeight;
                const ratioChange = Math.abs(currentAspectRatio - lastAspectRatio);
                
                // アスペクト比が大きく変わったら「折れた」とみなす
                if (ratioChange > 0.3) {
                     switchImage(image2Src);
                }
                lastAspectRatio = currentAspectRatio;
            });
        }

        // --- 以下、追加したアップロード機能 ---

        // 長押しで設定メニューを開く
        let longPressTimer;
        const HOLD_DURATION = 800; 

        document.addEventListener('touchstart', function(e) {
            if (overlay.style.display === 'flex') return;
            // 設定メニュー以外（画像部分）を長押しした場合のみ
            if (e.target === imgElement) {
                longPressTimer = setTimeout(() => openSettings(), HOLD_DURATION);
            }
        }, { passive: false });

        document.addEventListener('touchend', () => clearTimeout(longPressTimer));
        document.addEventListener('touchmove', () => clearTimeout(longPressTimer));
        window.addEventListener('contextmenu', e => e.preventDefault(), { passive: false });

        function openSettings() {
            overlay.style.display = 'flex';
        }
        function closeSettings() {
            overlay.style.display = 'none';
        }

        // 画像読込処理 (File API)
        const setupFileLoad = (inputId, isNormal) => {
            document.getElementById(inputId).addEventListener('change', function(e) {
                const file = e.target.files[0];
                if (file) {
                    const reader = new FileReader();
                    reader.onload = function(evt) {
                        const result = evt.target.result;
                        if (isNormal) {
                            image1Src = result;
                            document.getElementById('status-normal').innerText = file.name;
                            switchImage(image1Src); // 設定中はプレビューとして表示
                        } else {
                            image2Src = result;
                            document.getElementById('status-folded').innerText = file.name;
                            // 設定メニュー中はプレビューしない方が混乱しないかもですが、
                            // 確認したい場合はここで switchImage(image2Src) してもOK
                        }
                    };
                    reader.readAsDataURL(file);
                }
            });
        };

        setupFileLoad('file-normal', true);
        setupFileLoad('file-folded', false);

    </script>
</body>
</html>
